```
FDC-ML/
â”œâ”€ AIRestaurant/               # Django ì†ŒìŠ¤
â”œâ”€ fast_api/                   # fast api ì†ŒìŠ¤
â”œâ”€ monitoring/                 # ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ
â”‚  â”œâ”€ grafana-discord-relay 
â”‚  â”‚    â”œâ”€.env
â”‚  â”‚    â””â”€ relay.py
â”‚  â”œâ”€ prometheus 
â”‚  â”‚    â”œâ”€ prometheus.yml
â”‚  â”‚    â””â”€ rules.yml
â”‚  â”œâ”€ docker-compose.yml
â”‚  â””â”€ alertmanager.yml
â””â”€ .github/workflows/
   â”œâ”€ django-docker-ci.yml       # (ê¸°ì¡´ docker-ci.yml)
   â”œâ”€ deploy-ec2-compose.yml     # (ê¸°ì¡´ docker-deploy.yml)
   â””â”€ observability-validate.yml # (promtool/compose ê²€ì¦
```

- Python ê¸°ë°˜ ì„œë¹„ìŠ¤(FastAPI, Django, Relay)ì— í•„ìš”í•œ pip íŒ¨í‚¤ì§€
- Prometheus, Grafana, Alertmanager ë“±ì€ Docker ì´ë¯¸ì§€ ê¸°ë°˜ì´ë¼ pip ì„¤ì¹˜ ë¶ˆí•„ìš” (â†’ Docker Composeì—ì„œ ê´€ë¦¬ë¨)
---
í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜

Prometheus + ëª¨ë‹ˆí„°ë§ ì—°ë™
```bash
pip install prometheus-client   
# ë©”íŠ¸ë¦­ ë…¸ì¶œ (FastAPI/Django ê³µí†µ)

pip install prometheus-fastapi-instrumentator 
# FastAPI ìë™ ê³„ì¸¡ (ìš”ì²­/ì‘ë‹µ, latency ë“±)

pip install django-prometheus 
# Django ë©”íŠ¸ë¦­ ìˆ˜ì§‘ê¸° (ORM, ìš”ì²­ latency ë“±)
```

Grafana â†’ Discord Relay ê´€ë ¨
```bash
pip install flask             # Relay ì„œë²„ (ê°„ë‹¨í•œ API ì—”ë“œí¬ì¸íŠ¸)
pip install discord-webhook   # Discord Webhook ì „ì†¡ ìœ í‹¸
```
---
 `fastdining_api/monitoring/`
- ì—­í• : ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ(Docker Compose ê¸°ë°˜) ê´€ë¦¬

Grafana Alert â†’ Discord Webhookìœ¼ë¡œ ì „ë‹¬í•´ì£¼ëŠ” Python ìŠ¤í¬ë¦½íŠ¸
`monitoring/grafana-discord-relay/relay.py`
```yml
import os
from typing import Any, Dict, List, Optional

import httpx
from dotenv import load_dotenv
from fastapi import FastAPI
from pydantic import BaseModel, Field

load_dotenv()
DISCORD_WEBHOOK = os.getenv("DISCORD_WEBHOOK")
BOT_NAME = os.getenv("BOT_NAME", "í¬í´ ì•Œë¦¼ ë´‡")
BOT_AVATAR = os.getenv("BOT_AVATAR", "")
if not DISCORD_WEBHOOK:
    raise RuntimeError("DISCORD_WEBHOOK is not set. Put it in .env")

app = FastAPI(title="Grafana â†’ Discord Relay")

class AlertLabels(BaseModel):
    alertname: Optional[str] = None
    instance: Optional[str] = None
    severity: Optional[str] = None
    job: Optional[str] = None

class AlertAnnotations(BaseModel):
    summary: Optional[str] = None
    description: Optional[str] = None

class Alert(BaseModel):
    labels: AlertLabels = Field(default_factory=AlertLabels)
    annotations: AlertAnnotations = Field(default_factory=AlertAnnotations)
    startsAt: Optional[str] = None
    endsAt: Optional[str] = None
    generatorURL: Optional[str] = None

class GrafanaPayload(BaseModel):
    status: Optional[str] = "unknown"
    alerts: List[Alert] = Field(default_factory=list)

COLOR_MAP: Dict[str, int] = {
    "FIRING":   0xE74C3C,
    "RESOLVED": 0x2ECC71,
    "NO_DATA":  0x95A5A6,
    "ERROR":    0xE67E22,
    "PENDING":  0xF1C40F,
}

def _clip(s: Optional[str], limit: int) -> str:
    return (s or "")[:limit]

def _build_embeds(p: GrafanaPayload) -> List[Dict[str, Any]]:
    status = (p.status or "UNKNOWN").upper()
    color = COLOR_MAP.get(status, 0x3498DB)
    embeds: List[Dict[str, Any]] = []
    for a in p.alerts[:10]:
        name = a.labels.alertname or "Alert"
        title = _clip(f"{name} [{status}]", 256)
        description = "\n".join(
            [x for x in [a.annotations.summary, a.annotations.description] if x]
        )
        description = _clip(description, 4096)
        fields: List[Dict[str, Any]] = []
        if a.labels.instance:
            fields.append({"name": "instance", "value": _clip(a.labels.instance, 1024), "inline": True})
        if a.labels.severity:
            fields.append({"name": "severity", "value": _clip(a.labels.severity, 1024), "inline": True})
        if a.generatorURL:
            fields.append({"name": "link", "value": _clip(a.generatorURL, 1024), "inline": False})
        embeds.append({"title": title, "description": description, "color": color, "fields": fields})
    return embeds

@app.get("/")
async def root() -> Dict[str, Any]:
    return {"ok": True, "service": "grafana-discord-relay"}

@app.get("/health")
async def health() -> Dict[str, Any]:
    return {"ok": True}

@app.post("/grafana")
async def grafana_webhook(payload: GrafanaPayload) -> Dict[str, Any]:
    embeds = _build_embeds(payload)
    body: Dict[str, Any] = {"username": BOT_NAME}
    if BOT_AVATAR:
        body["avatar_url"] = BOT_AVATAR
    if embeds:
        body["embeds"] = embeds
    else:
        status = (payload.status or "UNKNOWN").upper()
        body["content"] = f"Grafana alert [{status}]"
    async with httpx.AsyncClient(timeout=10) as cli:
        resp = await cli.post(DISCORD_WEBHOOK, json=body)
        resp.raise_for_status()
    return {"ok": True}
```

Discord Webhook URL ê°™ì€ ë¯¼ê° ì„¤ì • ì €ì¥
`monitoring/grafana-discord-relay/.env`
```yml
DISCORD_WEBHOOK=https://discord.com/api/webhooks/1406859561033400460/Zpk7HDWh74GBd7wvTedma9cLpjX4E4etxGDCPgTAGTR0wmxvc2yCtE2J-CfS-hCD_hu8
BOT_NAME=í¬í´ ì•Œë¦¼ ë´‡
```

Prometheus ì„œë²„ ì„¤ì • (ì–´ë–¤ íƒ€ê²Ÿì—ì„œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í• ì§€ ì •ì˜)
`monitoring/prometheus/prometheus.yml`
```yml
global:
  scrape_interval: 15s  # â† (ì—­í• ) ì „ì²´ ìŠ¤í¬ë ˆì´í”„ ì£¼ê¸°

rule_files:
  - "/etc/prometheus/rules.yml"   # â† (ì—°ê²°ì ) ì•ŒëŒ ê·œì¹™ íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ê²½ë¡œë¡œ ë§ˆìš´íŠ¸í•´ ì‚¬ìš©

alerting:
  alertmanagers:
    - static_configs:
        - targets: ["host.docker.internal:9093"]  
        # â† (ì—°ê²°ì ) Alertmanager ì£¼ì†Œ (í˜¸ìŠ¤íŠ¸ í¬íŠ¸ 9093)

scrape_configs:
  - job_name: "fastapi"
    metrics_path: /metrics                
    # â† (ì—°ê²°ì ) FastAPIê°€ ë…¸ì¶œí•˜ëŠ” ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸
    
    static_configs:
      - targets: ["host.docker.internal:8000"]  
    # â† FastAPI ì„œë²„(í˜¸ìŠ¤íŠ¸)ì˜ 8000í¬íŠ¸

  - job_name: "django"
    metrics_path: /metrics                
    # â† (ì—°ê²°ì ) Djangoê°€ ë…¸ì¶œí•˜ëŠ” ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸
    
    static_configs:
      - targets: ["host.docker.internal:8900"]  
    # â† Django ì„œë²„(í˜¸ìŠ¤íŠ¸)ì˜ 8900í¬íŠ¸

  - job_name: "node_exporter"
    static_configs:
      - targets: ["host.docker.internal:9100"]  
    # â† (ì—°ê²°ì ) í˜¸ìŠ¤íŠ¸ Node Exporter

  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]  
    # â† (ì—­í• ) ìê¸° ìì‹ (Prometheus) ë©”íŠ¸ë¦­

```

Prometheus ì•ŒëŒ ê·œì¹™ ì •ì˜ (ì˜ˆ: CPU ì‚¬ìš©ë¥  ì„ê³„ì¹˜ ì´ˆê³¼ ì‹œ Alert ë°œìƒ)
ì„œë¹„ìŠ¤ ê°€ìš©ì„±(ì£½ì—ˆëŠ”ì§€), HTTP ì˜¤ë¥˜ìœ¨(ìƒëŒ€/ì ˆëŒ€), ì‘ë‹µ ì§€ì—°ì‹œê°„(p95), ê·¸ë¦¬ê³  í˜¸ìŠ¤íŠ¸ ë¦¬ì†ŒìŠ¤(CPU/ë©”ëª¨ë¦¬)ì— ëŒ€í•œ ì•ŒëŒ ê·œì¹™ì´ í¬í•¨

`monitoring/prometheus/rules.yml`
```yml
groups:
- name: uptime-and-error
  rules:
  # A-1. íƒ€ê²Ÿ ë‹¤ìš´ ê°ì§€ (up==0)
  - alert: TargetDown
    expr: up == 0 # â† (ì—°ê²°ì ) ëŒ€ìƒ(Target)ì´ ì£½ì—ˆëŠ”ì§€ (scrape ì‹¤íŒ¨)
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Target down: {{ $labels.job }} ({{ $labels.instance }})"
      description: "{{ $labels.instance }} of job {{ $labels.job }} is down for >2m."

  # A-2. 5xx ì˜¤ë¥˜ìœ¨(ì „ì²´) > 1%  (SLO ìœ„ë°˜)
  # â”” http_requests_total í˜•íƒœë¥¼ ì“°ëŠ” ê²½ìš°
  - alert: High5xxErrorRate
# â† (ì—°ê²°ì ) http_requests_total ë©”íŠ¸ë¦­ì„ ê°€ì •í•œ 5xx ë¹„ìœ¨ ê²½ë³´
    expr: |
      sum(rate(http_requests_total{status=~"5..", job=~"django|fastapi"}[5m]))
      /
      sum(rate(http_requests_total{job=~"django|fastapi"}[5m])) > 0.01
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "5xx ì˜¤ë¥˜ìœ¨ > 1%"
      description: "ìµœê·¼ 5ë¶„ 5xx ë¹„ìœ¨ì´ 1%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

  # A-3. 5xx ì ˆëŒ€ê°’(RPS) > 0.5 (íŠ¸ë˜í”½ ì ì„ ë•Œë„ ì¡ê¸°)
  - alert: High5xxAbsoluteRPS
    expr: sum(rate(http_requests_total{status=~"5..", job=~"django|fastapi"}[5m])) > 0.5
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "5xx ì´ˆë‹¹ ì‹¤íŒ¨ ê±´ìˆ˜ > 0.5"
      description: "5xxê°€ ì´ˆë‹¹ 0.5ê±´(í‰ê· ) ì´ìƒ ë°œìƒ ì¤‘."

- name: latency
  rules:
  # B-1. FastAPI p95 ì§€ì—°ì‹œê°„ > 500ms
  # â”” fastapi_request_latency_seconds_bucket ì“°ëŠ” ê²½ìš°
  - alert: FastAPIP95LatencyHigh
    expr: |
      histogram_quantile(
        0.95,
        sum by (le) (rate(fastapi_request_latency_seconds_bucket{endpoint!="/metrics"}[5m]))
      ) > 0.5
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "FastAPI p95 > 500ms"
      description: "ìµœê·¼ 5ë¶„ p95 ì‘ë‹µì§€ì—°ì´ 500ms ì´ˆê³¼."

  # B-2. Django DB ì¿¼ë¦¬ p95 > 200ms (ì¥ê³  ì „ìš© ë©”íŠ¸ë¦­ ê°€ì •)
  # â”” django_db_query_duration_seconds_bucket ì“°ëŠ” ê²½ìš°
  - alert: DjangoDBP95High
    expr: |
      histogram_quantile(
        0.95,
        sum by (le) (rate(django_db_query_duration_seconds_bucket[5m]))
      ) > 0.2
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "Django DB p95 > 200ms"
      description: "ìµœê·¼ 5ë¶„ p95 DB ì¿¼ë¦¬ ì§€ì—°ì´ 200ms ì´ˆê³¼."
      
- name: host
  rules:
  # C-1. CPU 80% ì´ˆê³¼ (node_exporter)
  - alert: HighCPUUsage
    expr: 1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "CPU > 80%"
      description: "ìµœê·¼ 5ë¶„ í‰ê·  CPU ì‚¬ìš©ë¥  80% ì´ˆê³¼."

  # C-2. ë©”ëª¨ë¦¬ ì—¬ìœ  < 10%
  - alert: LowMemory
    expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) < 0.10
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "ë©”ëª¨ë¦¬ ì—¬ìœ  < 10%"
      description: "ê°€ìš© ë©”ëª¨ë¦¬ê°€ 10% ë¯¸ë§Œ."
```

Alertmanager ì„¤ì • (ì•ŒëŒì„ Discord/Slack/ì´ë©”ì¼ë¡œ ì „ì†¡í•˜ëŠ” ê·œì¹™)
`monitoring/alertmanager.yml` ì•ŒëŒ ì „ë‹¬ ê·œì¹™(ì–´ë””ë¡œ ë³´ë‚¼ì§€)
```yml
global:
  resolve_timeout: 5m

route:
  receiver: "discord"

receivers:
  - name: "discord"
    webhook_configs:
      - url: "http://host.docker.internal:8800/grafana"
        send_resolved: true

```

Prometheus, Grafana, Alertmanager, Node Exporter ë“±ì„ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰í•˜ëŠ” ì„¤ì • íŒŒì¼ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì „ìš© (ì»¨í…Œì´ë„ˆ/í¬íŠ¸/ë³¼ë¥¨ ì—°ê²°)
`monitoring/docker-compose.yml`
```yml
version: "3.9"

networks:
  observability:
    driver: bridge

services:
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: unless-stopped
    networks: [observability]
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules.yml:/etc/prometheus/rules.yml:ro
    # host.docker.internal í•´ì„ì„ ìœ„í•´ í•„ìš” (Linux)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-lifecycle

  alertmanager:
    image: prom/alertmanager
    container_name: alertmanager
    restart: unless-stopped
    networks: [observability]
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro

  grafana:
    image: grafana/grafana
    container_name: grafana
    restart: unless-stopped
    networks: [observability]
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
    # (ì˜µì…˜) í˜¸ìŠ¤íŠ¸ ì ‘ê·¼ í¸ì˜
    extra_hosts:
      - "host.docker.internal:host-gateway"

  node_exporter:
    image: quay.io/prometheus/node-exporter:v1.7.0
    container_name: node_exporter
    restart: unless-stopped
    networks: [observability]
    ports:
      - "9100:9100"

volumes:
  grafana-data:
```
---

`fastdining_api/src/app.py` FastAPIì— ë©”íŠ¸ë¦­ ë¶™ì´ê¸°
```python
# ë¹„ì¦ˆë‹ˆìŠ¤/ì›¹í›… ë¼ìš°í„°
from prometheus_fastapi_instrumentator import Instrumentator, metrics
from src.routers.recommendations_router import router as recommendations_router

app.include_router(recommendations_router)

Instrumentator() \
    .add(metrics.default()) \
    .add(metrics.latency(buckets=(0.05, 0.1, 0.25, 0.5, 1.0, 2.0))) \
    .instrument(app) \
    .expose(app, endpoint="/metrics", include_in_schema=False)
```

`fastdining_api/main.py` FastAPI ì„œë²„ í¬íŠ¸/ë°”ì¸ë”©
```python
import uvicorn

def main():
    uvicorn.run(
        app="src.app:app", 
        host="0.0.0.0", 
        port=8000, 
        reload=True, 
        workers=1
    )

if __name__ == "__main__":
    main()
```

---
#### ğŸŒ ì„œë²„ ì‹¤í–‰ 

Relay ì„œë²„
```bash
cd fastdining_api/monitoring/grafana-discord-relay
uvicorn relay:app --host 0.0.0.0 --port 8800

# ê±´ê°• í™•ì¸
curl -s http://127.0.0.1:8800/health
```
- `--host` â†’ IP ì£¼ì†Œë‚˜ í˜¸ìŠ¤íŠ¸ ì§€ì • (`0.0.0.0`ì€ ì™¸ë¶€ ì ‘ì† í—ˆìš© ì˜ë¯¸)
- `--port` â†’ ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: `8000`)

fast api ì„œë²„
```bash
cd fastdining_api
source ~/fastdining_api/.venv/bin/activate
uvicorn src.app:app --host 0.0.0.0 --port 8000 --reload

# ë©”íŠ¸ë¦­ í™•ì¸
curl -s http://127.0.0.1:8000/metrics | head
```

django ì„œë²„
```bash
cd AIRestaurant
source ~/AIRestaurant/.venv/bin/activate
python manage.py runserver 0.0.0.0:8900

# ë©”íŠ¸ë¦­ í™•ì¸
curl -s http://127.0.0.1:8900/metrics | head
```

Node Exporter (í˜¸ìŠ¤íŠ¸ ë©”íŠ¸ë¦­ ìˆ˜ì§‘)
```bash
docker rm -f node_exporter 2>/dev/null || true
docker run -d --name node_exporter -p 9100:9100 quay.io/prometheus/node-exporter:v1.7.0

# í™•ì¸
curl -s http://127.0.0.1:9100/metrics | head
```

ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ (Prometheus/Grafana/Alertmanager)
```bash
cd ~/fastdining_api/monitoring
docker compose up -d   
# prometheus / grafana / node_exporter / (ìˆë‹¤ë©´ alertmanager)

docker ps  # í¬íŠ¸: 9090, 3000, 9100, 9093 í™•ì¸
```
í—¬ìŠ¤/ìƒíƒœ í™•ì¸:
```bash
docker ps
curl -s http://localhost:9090/-/ready        # Prometheus
curl -s http://localhost:9093/api/v2/status  # Alertmanager
curl -s http://localhost:3000/api/health     # Grafana


# ë¡œê·¸ í™•ì¸
docker compose logs --tail=100 -f prometheus
docker compose logs --tail=100 -f grafana
docker compose logs --tail=100 -f alertmanager
docker compose logs --tail=100 -f node_exporter
```

Prometheus & Grafana (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¬ì‚¬ìš©)
```bash
docker start prometheus grafana node_exporter
```

ëŒ€ì‹œë³´ë“œ/ì½˜ì†” ì£¼ì†Œ ëª¨ìŒ
- **Grafana**: [http://localhost:3000](http://localhost:3000)  (admin / admin)
    (ëŒ€ì‹œë³´ë“œ/ì•Œë¦¼ ì„¤ì •)
    ì‹œê°í™” ëŒ€ì‹œë³´ë“œ
    - Prometheus ë©”íŠ¸ë¦­ì„ ì°¨íŠ¸/ê·¸ë˜í”„ë¡œ ëª¨ë‹ˆí„°ë§
    - ì•Œë¦¼ ì„¤ì • ë° ëŒ€ì‹œë³´ë“œ ê´€ë¦¬
    
- **Prometheus**: [http://localhost:9090](http://localhost:9090)  
    (Targets/Alerts/PromQL)
    ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì„œë²„
    - FastAPI/Django/Node Exporterì—ì„œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
    - ì§ì ‘ ì¿¼ë¦¬ ê°€ëŠ¥ (PromQL)
    
- **Alertmanager**: [http://localhost:9093](http://localhost:9093)  
    ì•ŒëŒ ê´€ë¦¬ ì„œë²„
    - Prometheus ì•ŒëŒ ê·œì¹™ì—ì„œ ë°œìƒí•œ Alert ê´€ë¦¬
    - Discord/Slack/Emailë¡œ ì „ë‹¬
    
- **Node Exporter (metrics)**: [http://localhost:9100/metrics](http://localhost:9100/metrics)  
    ì„œë²„ OS/í•˜ë“œì›¨ì–´ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
    - CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬, ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
    
ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸:
- **Django**: [http://localhost:8900/metrics](http://localhost:8900/metrics)
- **FastAPI**: [http://localhost:8000/metrics](http://localhost:8000/metrics)









