SQL(DB) 모니터링이 필요한 이유

1. 서버 상태 확인 (DB 인스턴스 레벨)
- 접속 가능 여부 → DB가 살아있는지/죽었는지 감지
- CPU/메모리 사용량 → DB 서버 과부하 탐지
- 스토리지 용량 → 디스크 부족으로 장애 발생 방지
- 연결 수 → DB 커넥션 풀 고갈 여부 확인 (예: `too many connections` 오류)
- Replication Lag → 마스터–슬레이브 간 지연 체크 (읽기 일관성 보장)
    
---
2. 쿼리 성능/효율성 (SQL 실행 레벨)
- 슬로우 쿼리 감지 → p95/p99 응답시간 초과 쿼리 찾기
- 쿼리 빈도/패턴 분석 → 특정 쿼리 과다 호출 여부 (N+1 문제 등)
- 인덱스 사용 여부 → 풀 스캔(full scan) 탐지
- Lock/Deadlock 발생 → 트랜잭션 충돌 및 대기 시간 확인
- 캐시 Hit Ratio → 메모리 캐시 사용 비율 확인 (디스크 I/O 병목 방지)
    
---
3. 장애 예방/운영 효율
- 병목 지점 파악 → 애플리케이션 오류가 아니라 DB 과부하 문제일 수도 있음
- 용량 계획(Capacity Planning) → 데이터 크기/쿼리 부하 증가 추세 모니터링 → 스케일업/샤딩 시점 판단
- 알람 자동화 → “DB 연결 수 90% 이상” 등 경고 알림으로 사전 대응 가능
- 비용 최적화 → 클라우드 DB 과금(스토리지/쿼리 요청 수) 관리
    
---
요약:
- 서버 레벨: DB가 살아있는지, 자원 상태는 어떤지.
- 쿼리 레벨: SQL이 효율적으로 실행되는지, 병목은 없는지.
- 운영 레벨: 장애 예방, 용량 계획, 비용 최적화.

---
MySQL Exporter 설치
```
wget https://github.com/prometheus/mysqld_exporter/releases/latest/download/mysqld_exporter-<버전>.linux-amd64.tar.gz
tar xvfz mysqld_exporter-*.tar.gz
cd mysqld_exporter-*.linux-amd64
```

Prometheus가 MySQL 상태를 조회할 수 있도록 전용 계정을 만들어야 합니다.
```
CREATE USER 'exporter'@'localhost' IDENTIFIED BY '비밀번호';
GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'localhost';
FLUSH PRIVILEGES;
```

환경 변수로 MySQL 접속 정보 설정
```bash
export DATA_SOURCE_NAME="exporter:비밀번호@(localhost:3306)/"
```

MySQL Exporter 실행
```bash
./mysqld_exporter --web.listen-address=":9104"
```

Prometheus 설정(prometheus.yml)
```yml
scrape_configs:
  - job_name: "mysql"
    static_configs:
      - targets: ["localhost:9104"]
```

---
PostgreSQL Exporter (postgres_exporter)

설치 (로컬 바이너리 또는 도커 중 택1)
(A) 바이너리 방식
```bash
# 최신 릴리스 아카이브 다운로드 (버전은 릴리스 페이지 확인 후 대체)
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v<버전>/postgres_exporter-<버전>.linux-amd64.tar.gz
tar xvfz postgres_exporter-*.tar.gz
cd postgres_exporter-*.linux-amd64
```

(B) Docker 방식
```bash
docker run -d --name postgres_exporter -p 9187:9187 \
  -e DATA_SOURCE_NAME="postgresql://exporter:비밀번호@host.docker.internal:5432/postgres?sslmode=disable" \
  quay.io/prometheuscommunity/postgres-exporter:latest
```
포트 기본값은 **9187**입니다.

2) PostgreSQL에 전용 계정 생성 (+ 권한)
PostgreSQL 10+에서는 내장 역할 pg_monitor를 쓰면 대부분의 통계 뷰 접근이 가능합니다.
```
-- psql 등으로 접속 후 실행
CREATE USER exporter WITH PASSWORD '비밀번호';

-- 모니터링 전용 권한 부여
GRANT pg_monitor TO exporter;

-- 기본 검색 경로를 시스템 카탈로그로 고정(권장)
ALTER USER exporter SET SEARCH_PATH TO pg_catalog;
```

3) 접속 정보 환경변수 설정
```bash
export DATA_SOURCE_NAME="postgresql://exporter:비밀번호@localhost:5432/postgres?sslmode=disable"
```
- 접속 대상 DB: 위 예시는 `postgres`(기본 DB). 필요 시 운영 DB명으로 교체.
- 외부/컨테이너에서 접속 시 `pg_hba.conf`에 해당 클라이언트의 접근 허용 규칙이 있어야 합니다.

4) Exporter 실행
(A) 바이너리 실행
```bash
./postgres_exporter --web.listen-address=":9187"
```

(B) Docker 이미 사용 중이면 (이미 위에서 실행했다면 생략)
```bash
docker run -d --name postgres_exporter -p 9187:9187 \
  -e DATA_SOURCE_NAME="postgresql://exporter:비밀번호@host.docker.internal:5432/postgres?sslmode=disable" \
  quay.io/prometheuscommunity/postgres-exporter:latest
```
여러 DB를 관찰하려면 `--auto-discover-databases` 옵션을 쓰거나,  
`DATA_SOURCE_URI`/`DATA_SOURCE_USER`/`DATA_SOURCE_PASS` 조합을 사용해도 됩니다(환경에 따라).

Prometheus 스크레이프 설정 (`prometheus.yml`)
```yml
scrape_configs:
  - job_name: "postgres"
    static_configs:
      - targets: ["localhost:9187"]
```
도커 네트워크/쿠버네티스 환경에서는 `targets`에 컨테이너/서비스 이름을 사용하세요.  
예: `["postgres_exporter:9187"]`


